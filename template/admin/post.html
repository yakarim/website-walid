[%extends "../layouts/base.html"%]

[%block documentBody()%]
<div class="container">

  <div id="hello-vue" class="demo">
    <div class="row">
      <form @submit.prevent="handlePost">
        <div class="form-group">
          <input v-model="post.id" type="text" name="id" class="form-control my-input" id="id" hidden/>
        </div>
        <br />
        <div class="form-group">
          <input v-model="post.title" type="text" name="title" class="form-control my-input" id="title"
            placeholder="Title" />
        </div>
        <br />
        <div class="form-group">
          <input v-model="post.content" type="text" name="content" class="form-control my-input" id="content"
            placeholder="Content" />
        </div>
        <br />

        <br />
        <div class="text-center">
          <button type="submit" class="btn btn-primary">
            {{button}} Post
          </button>
        </div>
      </form>
    </div>
    <div class="row">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Title</th>
            <th scope="col">Content</th>
            <th scope="col">Author</th>
            <th scope="col">-</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(u, index) in posts" :key="u.ID">
            <th scope="row">{{ index + 1 }}</th>
            <td>{{ u.title }}</td>
            <td>{{ u.content }}</td>
            <td>{{ u.author_id }}</td>
            <td>
              <a @click="handleDelete(u.ID)" type="button" class="btn btn-danger">
                Delete
              </a>
              <a @click="updatePost(u)" type="button" class="btn btn-danger">
                Update
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>



  const HelloVueApp = {
    data() {
      return {
        posts: null,
        msg: "",
        showModal: false,
        button: "Create",
        post: {
          id: "",
          title: "",
          content: "",
        }
      }
    },
    mounted() {
      this.handleQuery();
    },
    methods: {
      handleQuery() {
        axios
          .get("/postapi/query")
          .then((res) => {
            this.posts = res.data.posts;
          })
          .catch((err) => {
            console.log(err);
          });
      },
      handlePost() {
        if (this.post.id == "") {
          var data = {
            "title": this.post.title,
            "content": this.post.content
          }
          axios
            .post("./postapi", data, {
              "Content-Type": "application/x-www-form-urlencoded",
            })
            .then((res) => {
              this.msg = res.data.msg;
              this.handleQuery();
              alert(this.msg)
            })
            .catch((err) => {
              this.msg = err.response.data.msg;
              alert(this.msg)

            });
        } else {
          var data = {
            "title": this.post.title,
            "content": this.post.content
          }
          axios
            .put("./postapi/"+ this.post.id, data, {
              "Content-Type": "application/x-www-form-urlencoded",
            })
            .then((res) => {
              this.msg = res.data.msg;
              this.handleQuery();
              alert(this.msg)
            })
            .catch((err) => {
              this.msg = err.response.data.msg;
              alert(this.msg)

            });
        }
      },
      updatePost(u) {
        this.post.id = u.ID
        this.post.title = u.title
        this.post.content = u.content
        this.button = "Update"
      },
      handleDelete(key) {
        axios
          .delete("/postapi/" + key)
          .then((res) => {
            this.msg = res.data.msg;
            this.handleQuery();
            alert(this.msg)
          })
          .catch((err) => {
            this.msg = err.response.data.msg;
            alert(this.msg)
          });
      },
    }
  }

  Vue.createApp(HelloVueApp).mount('#hello-vue')
</script>

[%end%]