[%extends "../layouts/base.html"%]

{{block button(label, href="javascript:void(0)")}}
<a href="{{ href }}">{{ label }}</a>
{{end}}

{{block ul()}}
<ul>
  {{yield content}}
</ul>
{{end}}

[%block documentBody()%]
<!-- Include the Quill library -->

<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.4/quill.js"></script>

<!-- Quill JS Vue -->
<script src="https://cdn.jsdelivr.net/npm/vue-quill-editor@3.0.6/dist/vue-quill-editor.js"></script>
<!-- Include stylesheet -->
<link href="https://cdn.quilljs.com/1.3.4/quill.core.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.4/quill.snow.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.4/quill.bubble.css" rel="stylesheet">

<style>
  .quill-editor,
  .content {
    background-color: white;
  }

  .editor {
    height: 300px;
  }
</style>
<div class="container">
  <div id="vueapp" class="demo">
    <div class="row">
      <form @submit.prevent="handlePost">
        <div class="form-group">
          <input v-model="post.id" type="text" name="id" class="form-control my-input" id="id" hidden />
        </div>
        <br />
        <div class="form-group">
          <input v-model="post.title" type="text" name="title" class="form-control my-input" id="title"
            placeholder="Title" />
        </div>
        <br />
        <div class="form-group">
          <input type="file" @change="uploadFunction" id="file" hidden>
          <quill-editor v-model="post.content" :options="editorOption" ref="quillEdit" />
        </div>

        <br />
        <div class="form-group">
          <div class="text-center">
            <button type="submit" class="btn btn-primary">
              {{button}} Post
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="row">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Title</th>
            <th scope="col">Content</th>
            <th scope="col">Author</th>
            <th scope="col">-</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(u, index) in posts" :key="u.ID">
            <th scope="row">{{ index + 1 }}</th>
            <td>{{ u.title }}</td>
            <td v-html="u.content"></td>
            <td>{{ u.author_id }}</td>
            <td>
              <a @click="updatePost(u)" type="button" class="btn">
                <i class="fas fa-user-edit"></i>
              </a>
              <a @click="handleDelete(u.ID)" class="btn">
                <i class="far fa-trash-alt"></i>
              </a>

            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  Vue.use(window.VueQuillEditor)

  new Vue({
    el: "#vueapp",
    data() {
      return {
        posts: null,
        msg: "",
        showModal: false,
        button: "Create",
        editorOption: {
          theme: 'snow',
          modules: {
            toolbar: {
              container: [["bold", "image"]],
              handlers: {
                image: function () {
                  document.getElementById('file').click()
                }
              }
            },
          }
        },
        post: {
          id: "",
          title: "",
          content: "",
        }
      }
    },
    mounted() {
      this.handleQuery();
    },

    methods: {
      handleQuery() {
        axios
          .get("/postapi/query")
          .then((res) => {
            this.posts = res.data.posts;
          })
          .catch((err) => {
            console.log(err);
          });
      },
      handlePost() {
        if (this.post.id == "") {
          var data = {
            "title": this.post.title,
            "content": this.post.content
          }
          axios
            .post("./postapi", data, {
              "Content-Type": "application/x-www-form-urlencoded",
            })
            .then((res) => {
              this.msg = res.data.msg;
              this.handleQuery();
              this.post = []
            })
            .catch((err) => {
              this.msg = err.response.data.msg;
              alert(this.msg)

            });
        } else {
          var data = {
            "title": this.post.title,
            "content": this.post.content
          }
          axios
            .put("./postapi/" + this.post.id, data, {
              "Content-Type": "application/x-www-form-urlencoded",
            })
            .then((res) => {
              this.msg = res.data.msg;
              this.handleQuery();
              this.post = []

            })
            .catch((err) => {
              this.msg = err.response.data.msg;
              alert(this.msg)

            });
        }
      },
      updatePost(u) {
        this.post.id = u.ID
        this.post.title = u.title
        this.post.content = u.content
        this.button = "Update"
      },
      handleDelete(key) {
        axios
          .delete("/postapi/" + key)
          .then((res) => {
            this.msg = res.data.msg;
            this.handleQuery();
            alert(this.msg)
          })
          .catch((err) => {
            this.msg = err.response.data.msg;
            alert(this.msg)
          });
      },
      onEditorChange({ quill, html, text }) {

        this.post.content = html
      },
      uploadFunction(e) {
        this.selectedFile = e.target.files[0];
        var form = new FormData();
        form.append("file", this.selectedFile);
        form.append("name", this.selectedFile.name);

        axios.post('./media-save', form, {
          'headers': {
            'Content-Type': "multipart/form-data"
          }
        })
          .then(r => {
            const range = this.$refs.quillEdit.quill.getSelection()
            this.$refs.quillEdit.quill.insertEmbed(range.index, 'image', `./${r.data.url}`)
          })
          .catch(r => {
            console.log('error')
          })
      }
    }
  })
</script>

[%end%]